---
title: Installing dynlib at NCI/gadi
layout: post
tags: python, fortran
---

Dynlib is meteorological analysis libary developed at University of Bergen. The central github repository is here : <https://git.app.uib.no/Clemens.Spensberger/dynlib>

Documentation for the library is available here : <https://folk.uib.no/csp001/dynlib_doc/intro.html>

# Dependencies

A list of dependencies to build the library is available here : <https://folk.uib.no/csp001/dynlib_doc/pkg.html>

Some of the analysis tools are compiled in Fortran, and the python tool `f2py` is used to link the Fortran modules to a python wrapper. Details about `f2py` are available at : <https://numpy.org/doc/stable/f2py/>

The main Fortran dependencies are:
- LAPACK (<https://netlib.org/lapack/>) -  libraries to solve linear equations.
- BLAS (<https://www.netlib.org/blas/>) - libraries for linear algebra.

These two libraries are available on NCI/gadi, see <https://opus.nci.org.au/pages/viewpage.action?pageId=248840668>

By loading the appropriate modules specified in that link, we can compile the `dynlib` fortran source. 

#  Installation

From a directory on gadi, type

{% highlight bash %}
$ git clone https://git.app.uib.no/Clemens.Spensberger/dynlib.git
Cloning into 'dynlib'...
remote: Enumerating objects: 4471, done.
remote: Counting objects: 100% (274/274), done.
remote: Compressing objects: 100% (105/105), done.
remote: Total 4471 (delta 224), reused 169 (delta 169), pack-reused 4197 (from 1)
Receiving objects: 100% (4471/4471), 1.86 MiB | 1010.00 KiB/s, done.
Resolving deltas: 100% (3055/3055), done.
Updating files: 100% (286/286), done.
{% endhighlight %}

You have now downloaded the latest version of the dynlib source files.  

These instructions will install dynlib using a standard NCI python environment, as I had problems linking the fortran modules with python using the CLEX ```analysis3``` conda environment.

Let's load the required modules. 
{% highlight bash %}
$ module load python3/3.10.0
Loading python3/3.10.0
  Loading requirement: intel-mkl/2021.4.0
{% endhighlight %}
Loading later python3 versions (e.g. python3.12.1) will fail because the library uses the deprecated `disutils` package for installation. 

Note this loads the required intel libraries required to compile the required fortran modules. You will need to upgrade the default version `gfortan` at NCI/gadi (8.5.0) so that it recognises the `-fallow-argument-mismatch`  provided in the file `/ext/spherepack3.2/make.inc` which passes parameters to the `spherepack` `Makefile`.
{% highlight bash %}
module load gcc/10.3.0
{% endhighlight %}
Now we need to edit the `compile` script to 
- Provide the python version (3)
- follow the NCI guidelines to load the LAPACK and BLAS libraries.

Edit line 13 of `compile` from
{% highlight bash %}
PY_VER=""
{% endhighlight %}

to 
{% highlight bash %}
PY_VER="3"
{% endhighlight %}

Edit line 60 from
{% highlight bash %}
LIBS="-L/usr/lib -L/usr/local/lib -L$(pwd)/ext/spherepack3.2/lib -lblas -llapack -lspherepack
{% endhighlight %}
to
{% highlight bash %}
LIBS="-L/usr/lib -L/usr/local/lib -L$(pwd)/ext/spherepack3.2/lib -lmkl_gf_lp64 -lmkl_core -lmkl_gnu_thread -lgomp -lm -lspherepack"
{% endhighlight %}

Then compile the libraries. Although the `compile` script does have `bash` logic to compile the `spherepack` modules, it may not work so you will have to compile these manually.
{% highlight bash %} 
$ 
{% endhighlight %}

